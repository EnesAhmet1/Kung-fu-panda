<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kung Fu Dojo: PRO LEADERBOARD</title>
    
    <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700;900&display=swap');

        body { 
            background-color: #020617; 
            color: white; 
            font-family: 'Exo 2', sans-serif; 
            overflow: hidden; 
            user-select: none;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .mode-btn { transition: all 0.3s ease; }
        .mode-btn:hover { background: rgba(255, 255, 255, 0.1); border-left: 4px solid #ef4444; }
        .mode-btn.active { background: linear-gradient(90deg, rgba(220, 38, 38, 0.2) 0%, transparent 100%); border-left: 4px solid #ef4444; color: #fff; }

        /* Tarama √áizgisi Efekti */
        .scan-effect::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to bottom, transparent 50%, rgba(0, 255, 0, 0.02) 51%, transparent 51%);
            background-size: 100% 4px; pointer-events: none; z-index: 50;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- OYUN MODLARI (V5 Yok, Her biri i√ßin ayrƒ± leaderkey var) ---
        const MODES = {
            V1: { 
                id: 'V1', title: 'ZEN MODE', subtitle: 'Eƒüitim', 
                desc: 'Puan yok. Skor tablosu yok. Sadece pratik.',
                mirror: false, score: false, timer: false, bombs: false 
            },
            V2: { 
                id: 'V2', title: 'SPEED TEST', subtitle: 'Refleks', 
                desc: '20 Saniye. Hƒ±z testi. √ñzel Liderlik Tablosu.',
                mirror: true, score: true, timer: 20, bombs: false 
            },
            V3: { 
                id: 'V3', title: 'ARCADE LAMP', subtitle: 'G√∂rsel ≈û√∂len', 
                desc: 'Lambalar ve Bombalar. √ñzel Liderlik Tablosu.',
                type: 'LAMP', mirror: true, score: true, timer: 20, bombs: true 
            },
            V4: { 
                id: 'V4', title: 'GOLD RUSH', subtitle: 'Hazine Avƒ±', 
                desc: 'Bol Altƒ±n. 60 Saniye. √ñzel Liderlik Tablosu.',
                type: 'LAMP', mirror: true, score: true, timer: 60, bombs: true, goldBias: true 
            },
            V6: { 
                id: 'V6', title: 'ULTIMATE', subtitle: 'Hardcore', 
                desc: 'Siyah top √∂ld√ºr√ºr. Taktiksel. √ñzel Liderlik Tablosu.',
                type: 'HARDCORE', mirror: true, score: true, timer: false, bombs: true 
            }
        };

        const App = () => {
            const [currentMode, setCurrentMode] = useState('V1');
            const [uiState, setUiState] = useState('LOADING'); 
            const [cameraStatus, setCameraStatus] = useState('Ba≈ülatƒ±lƒ±yor...');
            
            // Oyun Verileri
            const [scoreDisplay, setScoreDisplay] = useState(0);
            const [timerDisplay, setTimerDisplay] = useState(0);
            const [livesDisplay, setLivesDisplay] = useState(3);
            
            // Liderlik Tablosu State'leri
            const [playerName, setPlayerName] = useState('');
            const [leaderboardList, setLeaderboardList] = useState([]);
            const [isScoreSaved, setIsScoreSaved] = useState(false);

            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            
            // Oyun D√∂ng√ºs√º Referanslarƒ±
            const gameRef = useRef({
                active: false,
                mode: 'V1',
                score: 0,
                lives: 3,
                hand: { x: 0.5, y: 0.5, visible: false },
                targets: [],
                lastSpawnTime: 0
            });
            
            const loopRef = useRef(null);
            const timerIntervalRef = useRef(null);

            // --- BA≈ûLATMA ---
            useEffect(() => {
                const initSystem = async () => {
                    try {
                        setCameraStatus('Kamera ƒ∞zni Bekleniyor...');
                        const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } });
                        if (videoRef.current) {
                            videoRef.current.srcObject = stream;
                            videoRef.current.play();
                            
                            setCameraStatus('Yapay Zeka Y√ºkleniyor...');
                            const hands = new window.Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/${file}`});
                            hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
                            hands.onResults((results) => {
                                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                                    const lm = results.multiHandLandmarks[0][8];
                                    gameRef.current.hand = { x: lm.x, y: lm.y, visible: true };
                                } else { gameRef.current.hand.visible = false; }
                            });

                            const camera = new window.Camera(videoRef.current, {
                                onFrame: async () => { await hands.send({image: videoRef.current}); },
                                width: 1280, height: 720
                            });
                            await camera.start();
                            
                            setCameraStatus('HAZIR');
                            setUiState('MENU');
                            loopRef.current = requestAnimationFrame(renderLoop);
                        }
                    } catch (err) { setCameraStatus('HATA: ' + err.message); }
                };
                initSystem();
                return () => cancelAnimationFrame(loopRef.current);
            }, []);

            // --- OYUN MOTORU (RENDER LOOP) ---
            const renderLoop = () => {
                if (!canvasRef.current) return;
                const ctx = canvasRef.current.getContext('2d');
                const width = canvasRef.current.width;
                const height = canvasRef.current.height;
                const state = gameRef.current;
                const config = MODES[state.mode];

                ctx.clearRect(0, 0, width, height);

                // Hedefler
                if (state.active) {
                    const now = Date.now();
                    if (state.targets.length === 0 && now - state.lastSpawnTime > 200) spawnTarget();

                    state.targets.forEach((t, index) => {
                        if (now - t.spawnTime > t.duration) {
                            state.targets.splice(index, 1);
                            return;
                        }

                        const x = t.x * width;
                        const y = t.y * height;
                        
                        // Lamba Glow
                        if (config.type === 'LAMP' || config.type === 'HARDCORE') {
                            ctx.shadowBlur = 30; ctx.shadowColor = t.color;
                        } else { ctx.shadowBlur = 0; }

                        ctx.beginPath(); ctx.arc(x, y, t.radius, 0, 2 * Math.PI);
                        ctx.fillStyle = t.type === 'BOMB' ? '#000' : t.color;
                        ctx.fill();
                        ctx.lineWidth = 4; ctx.strokeStyle = t.type === 'BOMB' ? 'red' : 'white'; ctx.stroke();
                        
                        ctx.shadowBlur = 0; ctx.fillStyle = 'white'; ctx.font = 'bold 24px Arial';
                        ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(t.icon, x, y);
                    });
                }

                // El
                if (state.hand.visible) {
                    let hx = state.hand.x;
                    if (config.mirror) hx = 1 - hx;
                    const cx = hx * width; const cy = state.hand.y * height;

                    ctx.beginPath(); ctx.arc(cx, cy, 15, 0, 2 * Math.PI);
                    ctx.fillStyle = 'rgba(255,255,255,0.8)'; ctx.fill();
                    ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 3; ctx.stroke();

                    if (state.active) {
                        state.targets.forEach((t, index) => {
                            const tx = t.x * width; const ty = t.y * height;
                            if (Math.sqrt((cx - tx) ** 2 + (cy - ty) ** 2) < t.radius + 15) handleHit(t, index);
                        });
                    }
                }
                loopRef.current = requestAnimationFrame(renderLoop);
            };

            // --- OYUN MANTIƒûI ---
            const spawnTarget = () => {
                const config = MODES[gameRef.current.mode];
                const positions = [{x:0.2, y:0.3}, {x:0.5, y:0.3}, {x:0.8, y:0.3}, {x:0.2, y:0.7}, {x:0.5, y:0.7}, {x:0.8, y:0.7}];
                const colors = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'];
                
                const pos = positions[Math.floor(Math.random() * positions.length)];
                let type = 'NORMAL', color = colors[Math.floor(Math.random() * colors.length)], icon = '+1';
                let duration = gameRef.current.mode === 'V2' ? 800 : 1200;

                if (config.bombs) {
                    const r = Math.random() * 100;
                    if (r < (config.goldBias ? 30 : 10)) { type = 'GOLD'; color = '#fbbf24'; icon = '+3'; } 
                    else if (r < 40) { type = 'BOMB'; color = '#000000'; icon = '‚ò†Ô∏è'; }
                }

                gameRef.current.targets.push({ x: pos.x, y: pos.y, color, type, icon, radius: 50, spawnTime: Date.now(), duration });
                gameRef.current.lastSpawnTime = Date.now();
            };

            const handleHit = (target, index) => {
                const state = gameRef.current;
                state.targets.splice(index, 1);
                if (target.type === 'BOMB') {
                    if (MODES[state.mode].bombs) {
                        state.lives -= 1; setLivesDisplay(state.lives);
                        if (state.lives <= 0) endGame();
                    }
                } else {
                    if (MODES[state.mode].score) {
                        state.score += (target.type === 'GOLD' ? 3 : 1);
                        setScoreDisplay(state.score);
                    }
                }
            };

            const startGame = () => {
                const config = MODES[currentMode];
                gameRef.current = { ...gameRef.current, active: true, mode: currentMode, score: 0, lives: 3, targets: [], lastSpawnTime: 0 };
                setScoreDisplay(0); setLivesDisplay(3); setUiState('PLAYING');

                if (config.timer) {
                    let t = config.timer;
                    setTimerDisplay(t);
                    if (timerIntervalRef.current) clearInterval(timerIntervalRef.current);
                    timerIntervalRef.current = setInterval(() => {
                        t--; setTimerDisplay(t);
                        if (t <= 0) endGame();
                    }, 1000);
                } else { setTimerDisplay(null); }
            };

            const endGame = () => {
                gameRef.current.active = false;
                if (timerIntervalRef.current) clearInterval(timerIntervalRef.current);
                setUiState('GAMEOVER');
                setIsScoreSaved(false);
                setPlayerName('');
                loadLeaderboard(currentMode); // Oyun bitince o modun listesini y√ºkle
            };

            // --- LIDERLIK TABLOSU ƒ∞≈ûLEMLERƒ∞ ---
            const loadLeaderboard = (modeId) => {
                const key = `dojo_leaderboard_${modeId}`; // √ñZEL ANAHTAR: Her mod i√ßin farklƒ±
                const data = JSON.parse(localStorage.getItem(key) || '[]');
                setLeaderboardList(data);
            };

            const saveCurrentScore = () => {
                if (!playerName.trim()) return;
                const key = `dojo_leaderboard_${currentMode}`;
                const newEntry = { name: playerName.substring(0, 10), score: scoreDisplay, date: new Date().toLocaleDateString() };
                const updated = [...leaderboardList, newEntry].sort((a,b) => b.score - a.score).slice(0, 5);
                localStorage.setItem(key, JSON.stringify(updated));
                setLeaderboardList(updated);
                setIsScoreSaved(true);
            };

            // --- ARAY√úZ ---
            return (
                <div className="flex h-screen w-full relative scan-effect">
                    
                    {/* SOL MEN√ú */}
                    <div className="w-80 h-full glass-panel z-20 flex flex-col p-6 relative">
                        <div className="mb-8">
                            <h1 className="text-3xl font-black italic text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-orange-500">
                                DOJO LEADER
                            </h1>
                            <p className="text-xs text-gray-400">HER MODA √ñZEL Lƒ∞STE</p>
                        </div>
                        <div className="flex-1 overflow-y-auto space-y-2 pr-2">
                            {Object.values(MODES).map((mode) => (
                                <button key={mode.id} onClick={() => { setCurrentMode(mode.id); setUiState('MENU'); }}
                                    disabled={uiState === 'PLAYING'}
                                    className={`mode-btn w-full text-left p-4 rounded bg-gray-900/50 border border-gray-700 ${currentMode === mode.id ? 'active' : 'text-gray-400'}`}>
                                    <div className="font-bold">{mode.id}: {mode.title}</div>
                                    <div className="text-xs opacity-70">{mode.desc}</div>
                                </button>
                            ))}
                        </div>
                        <div className="mt-auto pt-4 border-t border-gray-700 text-xs">
                             <span className={cameraStatus === 'HAZIR' ? 'text-green-500' : 'text-yellow-500'}>‚óè {cameraStatus}</span>
                        </div>
                    </div>

                    {/* SAƒû PANEL */}
                    <div className="flex-1 bg-black flex items-center justify-center p-8 relative">
                         <div className="relative w-full max-w-[1280px] aspect-video bg-gray-900 rounded-2xl overflow-hidden shadow-2xl border-2 border-gray-800">
                            
                            <video ref={videoRef} className={`absolute w-full h-full object-cover opacity-40 ${MODES[currentMode].mirror ? 'transform scale-x-[-1]' : ''}`} autoPlay muted playsInline></video>
                            <canvas ref={canvasRef} width={1280} height={720} className="absolute w-full h-full z-10"></canvas>

                            {/* HUD */}
                            <div className="absolute top-0 left-0 w-full p-6 flex justify-between z-20 pointer-events-none">
                                <div className="glass-panel px-6 py-2 rounded-full font-bold text-red-500 flex gap-4">
                                    {MODES[currentMode].title}
                                    {MODES[currentMode].timer !== false && <span className="text-white font-mono">{timerDisplay}s</span>}
                                </div>
                                {MODES[currentMode].score && <div className="glass-panel px-6 py-2 rounded-full font-bold text-yellow-400">SKOR: {scoreDisplay}</div>}
                            </div>
                            
                            {/* Canlar */}
                            {MODES[currentMode].bombs && (
                                <div className="absolute bottom-6 left-6 z-20 text-4xl flex gap-1">
                                    {[...Array(3)].map((_, i) => <span key={i} className={i < livesDisplay ? '' : 'grayscale opacity-20'}>‚ù§Ô∏è</span>)}
                                </div>
                            )}

                            {/* --- MODALLER --- */}
                            {uiState === 'MENU' && (
                                <div className="absolute inset-0 bg-black/60 backdrop-blur-sm flex flex-col items-center justify-center z-40">
                                    <h2 className="text-6xl font-black text-white">{MODES[currentMode].title}</h2>
                                    <p className="text-gray-300 mb-8 mt-2">{MODES[currentMode].subtitle}</p>
                                    <button onClick={startGame} disabled={cameraStatus !== 'HAZIR'}
                                        className="px-12 py-4 bg-red-600 rounded font-black text-xl hover:scale-105 transition-all text-white disabled:opacity-50">
                                        BA≈ûLAT
                                    </button>
                                </div>
                            )}

                            {/* --- OYUN Bƒ∞TTƒ∞ & Lƒ∞DERLƒ∞K TABLOSU --- */}
                            {uiState === 'GAMEOVER' && (
                                <div className="absolute inset-0 bg-gray-900/95 backdrop-blur-md flex flex-col items-center justify-center z-50 p-8">
                                    <h2 className="text-5xl font-black text-red-500 mb-2">OYUN Bƒ∞TTƒ∞</h2>
                                    <div className="text-4xl font-bold text-white mb-8">SKORUN: <span className="text-yellow-400">{scoreDisplay}</span></div>

                                    {/* Skor Kayƒ±t Formu (Sadece skor modu a√ßƒ±ksa) */}
                                    {MODES[currentMode].score ? (
                                        <div className="flex gap-8 w-full max-w-4xl">
                                            {/* Sol: Kayƒ±t Alanƒ± */}
                                            <div className="flex-1 bg-black/40 p-6 rounded-xl border border-gray-700 flex flex-col items-center justify-center">
                                                <h3 className="text-xl font-bold text-gray-300 mb-4">Skorunu Kaydet</h3>
                                                {!isScoreSaved ? (
                                                    <div className="flex flex-col gap-3 w-full max-w-xs">
                                                        <input type="text" placeholder="ƒ∞smini Yaz (Max 10)" maxLength="10" 
                                                            className="bg-gray-800 text-white px-4 py-3 rounded text-center outline-none focus:ring-2 ring-red-500"
                                                            value={playerName} onChange={(e) => setPlayerName(e.target.value)} />
                                                        <button onClick={saveCurrentScore} className="bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded transition-colors">
                                                            Lƒ∞STEYE EKLE
                                                        </button>
                                                    </div>
                                                ) : <div className="text-green-400 font-bold text-xl">‚úÖ KAYDEDƒ∞LDƒ∞!</div>}
                                            </div>

                                            {/* Saƒü: Liderlik Tablosu */}
                                            <div className="flex-1 bg-black/40 p-6 rounded-xl border border-gray-700">
                                                <h3 className="text-xl font-bold text-yellow-500 mb-4 flex justify-between">
                                                    <span>üèÜ TOP 5</span>
                                                    <span className="text-xs bg-gray-700 px-2 py-1 rounded text-white">{currentMode} √ñZEL</span>
                                                </h3>
                                                <div className="space-y-2">
                                                    {leaderboardList.length === 0 ? <p className="text-gray-500 text-sm">Hen√ºz kayƒ±t yok.</p> : 
                                                        leaderboardList.map((entry, i) => (
                                                            <div key={i} className="flex justify-between items-center p-3 bg-gray-800 rounded border border-gray-700/50">
                                                                <span className="font-bold text-gray-300">{i+1}. {entry.name}</span>
                                                                <span className="font-mono font-bold text-yellow-400">{entry.score}</span>
                                                            </div>
                                                        ))
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    ) : <p className="text-gray-400 mb-6">Bu modda skor kaydƒ± yoktur.</p>}

                                    <div className="flex gap-4 mt-8">
                                        <button onClick={startGame} className="px-8 py-3 bg-white text-black font-bold rounded hover:bg-gray-200">TEKRAR</button>
                                        <button onClick={() => setUiState('MENU')} className="px-8 py-3 bg-transparent border border-gray-500 text-white font-bold rounded hover:bg-gray-800">MEN√ú</button>
                                    </div>
                                </div>
                            )}

                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>